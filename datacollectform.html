<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anadi Godham | Republic Day Rewards</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Screenshot Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --saffron: #FF9933;
            --green: #138808;
            --navy: #000080;
            --white: #ffffff;
            --glass-panel: rgba(255, 255, 255, 0.85);
            --glass-card: rgba(255, 255, 255, 0.95);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: linear-gradient(135deg, #ffa200 0%, #FFFFFF 50%, #125518 100%); 
            font-family: 'Poppins', sans-serif; 
            min-height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            padding: 15px; 
            color: var(--navy);
        }

        /* SPINNING CHAKRA BG */
        .chakra-bg {
            position: fixed; top: 50%; left: 50%; width: 140vw; height: 140vw; 
            background: url("https://upload.wikimedia.org/wikipedia/commons/1/17/Ashoka_Chakra.svg") no-repeat center/contain;
            opacity: 0.1; 
            transform: translate(-50%, -50%); z-index: -1; 
            animation: spinBg 60s linear infinite;
        }
        @keyframes spinBg { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* MAIN CONTAINER */
        .app-container { 
            width: 100%; max-width: 400px; /* Slightly reduced max-width for better fit */
            padding: 25px 20px; 
            border-radius: 25px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); 
            border: 2px solid rgba(255, 255, 255, 0.8);
            text-align: center; position: relative;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px);
            overflow: hidden; /* Ensures nothing goes outside */
        }

        .tricolor-strip {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, var(--saffron), #fff, var(--green));
        }

        /* HEADER */
        .logo { 
            width: 70px; height: 70px; border-radius: 50%; 
            border: 3px solid var(--navy); padding: 3px; background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 { font-family: 'Playfair Display', serif; color: var(--navy); font-size: 24px; margin: 10px 0 2px; }
        .subtitle { color: var(--saffron); font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px; }

        /* FORMS */
        .input-group { margin-bottom: 12px; text-align: left; width: 100%; }
        .input-group label { font-size: 12px; font-weight: 700; color: var(--navy); margin-left: 5px; margin-bottom: 3px; display: block; }
        
        input, textarea, select { 
            width: 100%; padding: 12px 14px; 
            border: 1px solid rgba(255,255,255,0.4); border-radius: 12px; 
            background: rgba(255, 255, 255, 0.65);
            outline: none; font-size: 14px; color: #333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        
        input:focus, textarea:focus {
            background: #fff;
            border-color: var(--navy);
        }
        
        input[type="date"] {
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
        }

        .primary-btn { 
            width: 100%; padding: 14px; margin-top: 8px;
            background: linear-gradient(90deg, var(--navy), #2a2a8a); 
            color: white; border: none; border-radius: 50px; 
            font-size: 16px; font-weight: 700; cursor: pointer; 
            box-shadow: 0 8px 20px rgba(0, 0, 128, 0.3);
            transition: 0.2s;
        }
        .primary-btn:active { transform: scale(0.98); }

        /* --- GAME SECTION --- */
        #game-section { display: none; min-height: 450px; }
        
        .card-stage { 
            display: none; 
            transition: all 0.5s ease;
        }
        .card-stage.active { display: block; }
        
        /* ZOOM EFFECT CLASS */
        .card-zoomed {
            transform: scale(1.05);
            z-index: 10;
        }

        /* CARD STYLING */
        .scratch-card-box { 
            background: var(--glass-card);
            width: 100%; max-width: 280px; margin: 0 auto 20px;
            border-radius: 18px; padding: 12px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); 
            border: 2px solid #fff; position: relative;
        }

        .scratch-canvas-container {
            width: 230px; height: 230px; margin: 0 auto; 
            border-radius: 12px; overflow: hidden; position: relative;
            background: #f9f9f9;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .prize-reveal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 1;
        }

        .prize-tag { background: var(--navy); color: #fff; font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; margin-bottom: 5px; }
        .prize-value { font-family: 'Playfair Display', serif; font-size: 24px; color: var(--saffron); font-weight: 700; line-height: 1.1; margin-bottom: 5px; }
        .condition-text { 
            font-size: 12px; color: #138808; font-weight: 700; 
            margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 4px; 
        }
        .prize-code { font-family: monospace; font-size: 13px; background: #eee; padding: 5px 10px; border-radius: 6px; color: #333; font-weight: bold; }

        canvas { position: absolute; top: 0; left: 0; z-index: 2; cursor: crosshair; transition: opacity 0.8s; }

        /* NEXT BUTTON */
        .next-action-btn {
            display: none;
            background: var(--saffron); color: white;
            padding: 10px 25px; border-radius: 30px;
            font-weight: 700; font-size: 14px;
            border: none; margin-top: 15px;
            box-shadow: 0 5px 15px rgba(255, 153, 51, 0.4);
            animation: bounceIn 0.5s; cursor: pointer;
        }
        @keyframes bounceIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- FINAL SUMMARY --- */
        #final-summary { display: none; width: 100%; animation: popIn 0.6s ease; }
        
        .final-card-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        
        .final-card {
            background: #fff; border-radius: 12px; padding: 12px;
            border: 1px solid var(--navy); display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: left;
        }
        
        .fc-left { flex: 1; }
        .fc-tag { font-size: 9px; font-weight: 800; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .fc-prize { font-family: 'Playfair Display'; font-size: 18px; color: var(--navy); font-weight: 700; margin: 2px 0; }
        .fc-cond { font-size: 11px; color: var(--green); font-weight: 700; }
        
        .fc-right { text-align: right; }
        .fc-code { font-family: monospace; font-size: 10px; background: #f0f0f0; padding: 4px 6px; border-radius: 4px; color: #555; display: inline-block; margin-top: 5px; }

        .confetti { position: fixed; width: 8px; height: 8px; z-index: 100; animation: fall linear forwards; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* Loader */
        .loader-overlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:50; justify-content:center; align-items:center; flex-direction:column; border-radius:30px; }
    </style>
</head>
<body>

    <div class="chakra-bg"></div>

    <div class="app-container" id="captureArea">
        <div class="tricolor-strip"></div>

        <!-- LOADER -->
        <div class="loader-overlay" id="loader">
            <img src="https://upload.wikimedia.org/wikipedia/commons/1/17/Ashoka_Chakra.svg" width="50" style="animation:spinBg 1s infinite linear;">
            <p style="margin-top:10px; font-weight:600; font-size:14px;">Loading...</p>
        </div>

        <!-- 1. REGISTRATION -->
        <div id="reg-view">
            <div class="logo-wrapper"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTuMrCVkyn9HWP12QqXQSutX0EmPRQ0b4pXUA&s" class="logo"></div>
            <h1>Anadi Godham</h1>
            <p class="subtitle">Republic Day Utsav</p>

            <form id="regForm">
                <div class="input-group"><label>Full Name</label><input type="text" id="name" required></div>
                <div class="input-group"><label>WhatsApp Number</label><input type="tel" id="phone" pattern="[0-9]{10}" required></div>
                <div class="input-group"><label>Address</label><textarea id="address" rows="1" required></textarea></div>
                
                <!-- STACKED DATES (Fixed Layout Issue) -->
                <div class="input-group">
                    <label>Date of Birth</label>
                    <input type="date" id="dob" required>
                </div>
                
                <div class="input-group">
                    <label>Anniversary Date <span style="font-weight:400; font-size:10px; color:#666;">(Optional)</span></label>
                    <input type="date" id="anniv">
                </div>

                <button type="submit" class="primary-btn">Start Scratching üéÅ</button>
            </form>
        </div>

        <!-- 2. GAME SECTION -->
        <div id="game-section">
            
            <!-- STAGE 1: PLATINUM -->
            <div class="card-stage active" id="stage-1">
                <p style="font-size:13px; font-weight:700; margin-bottom:12px; color:#555;">Card 1: Platinum Reward</p>
                
                <div class="scratch-card-box" id="box-1">
                    <div class="scratch-canvas-container">
                        <div class="prize-reveal">
                            <span class="prize-tag">PLATINUM</span>
                            <span class="prize-value">500g Paneer</span>
                            <span class="condition-text">On Monthly Bill > ‚Çπ8,000</span>
                            <div class="prize-code" id="code-1">...</div>
                        </div>
                        <canvas id="cv1"></canvas>
                    </div>
                </div>
                <button class="next-action-btn" id="btn-1" onclick="nextCard(1)">üëâ Claim & Next</button>
            </div>

            <!-- STAGE 2: GOLD -->
            <div class="card-stage" id="stage-2">
                <p style="font-size:13px; font-weight:700; margin-bottom:12px; color:#555;">Card 2: Gold Reward</p>
                
                <div class="scratch-card-box" id="box-2">
                    <div class="scratch-canvas-container">
                        <div class="prize-reveal">
                            <span class="prize-tag">GOLD</span>
                            <span class="prize-value">250g Paneer</span>
                            <span class="condition-text">On Monthly Bill > ‚Çπ6,000</span>
                            <div class="prize-code" id="code-2">...</div>
                        </div>
                        <canvas id="cv2"></canvas>
                    </div>
                </div>
                <button class="next-action-btn" id="btn-2" onclick="nextCard(2)">üëâ Claim & Next</button>
            </div>

            <!-- STAGE 3: SILVER -->
            <div class="card-stage" id="stage-3">
                <p style="font-size:13px; font-weight:700; margin-bottom:12px; color:#555;">Card 3: Silver Reward</p>
                
                <div class="scratch-card-box" id="box-3">
                    <div class="scratch-canvas-container">
                        <div class="prize-reveal">
                            <span class="prize-tag">SILVER</span>
                            <span class="prize-value">2L Chanch</span>
                            <span class="condition-text">On Monthly Bill > ‚Çπ4,000</span>
                            <div class="prize-code" id="code-3">...</div>
                        </div>
                        <canvas id="cv3"></canvas>
                    </div>
                </div>
                <button class="next-action-btn" id="btn-3" onclick="nextCard(3)">üëâ Finish & View All</button>
            </div>

        </div>

        <!-- 3. FINAL SUMMARY -->
        <div id="final-summary">
            <div class="logo-wrapper"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTuMrCVkyn9HWP12QqXQSutX0EmPRQ0b4pXUA&s" class="logo" style="width:60px; height:60px;"></div>
            <h2 style="font-family:'Playfair Display'; color:var(--navy); font-size:22px; margin:5px 0;">Congratulations!</h2>
            <p style="font-size:12px; color:#555; margin-bottom:15px;">Take a screenshot and show at billing.</p>

            <div class="final-card-list">
                <!-- Large Card 1 -->
                <div class="final-card" style="border-left: 5px solid var(--saffron);">
                    <div class="fc-left">
                        <div class="fc-tag">PLATINUM REWARD</div>
                        <div class="fc-prize">500g Paneer</div>
                        <div class="fc-cond">Condition: Bill > ‚Çπ8,000</div>
                    </div>
                    <div class="fc-right">
                        <div class="fc-code" id="sum-code-1">...</div>
                    </div>
                </div>

                <!-- Large Card 2 -->
                <div class="final-card" style="border-left: 5px solid #FFD700;">
                    <div class="fc-left">
                        <div class="fc-tag">GOLD REWARD</div>
                        <div class="fc-prize">250g Paneer</div>
                        <div class="fc-cond">Condition: Bill > ‚Çπ6,000</div>
                    </div>
                    <div class="fc-right">
                        <div class="fc-code" id="sum-code-2">...</div>
                    </div>
                </div>

                <!-- Large Card 3 -->
                <div class="final-card" style="border-left: 5px solid #C0C0C0;">
                    <div class="fc-left">
                        <div class="fc-tag">SILVER REWARD</div>
                        <div class="fc-prize">2L Chanch</div>
                        <div class="fc-cond">Condition: Bill > ‚Çπ4,000</div>
                    </div>
                    <div class="fc-right">
                        <div class="fc-code" id="sum-code-3">...</div>
                    </div>
                </div>
            </div>

            <button class="primary-btn" id="saveBtn" onclick="saveScreenshot()">üì∏ Save Ticket</button>
        </div>

    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzNbonwJPMG_mDtk-5XxDATa-yoPNYmlSEztgrzfBsLAWC-m7WZq3z_hELfXCqFxzK/exec';
        
        // --- DATA SETUP ---
        document.getElementById('regForm').addEventListener('submit', function(e){
            e.preventDefault();
            document.getElementById('loader').style.display = 'flex';

            // Generate Codes
            const r = () => Math.floor(1000 + Math.random() * 9000);
            const c1 = "AG-PL-"+r(), c2 = "AG-GD-"+r(), c3 = "AG-SL-"+r();

            // Set Codes in DOM
            ['1','2','3'].forEach((n, i) => {
                const code = [c1, c2, c3][i];
                document.getElementById('code-'+n).innerText = code;
                document.getElementById('sum-code-'+n).innerText = code;
            });

            // Get Form Data
            const formData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                dob: document.getElementById('dob').value,
                anniv: document.getElementById('anniv').value,
                c1, c2, c3
            };
            
            // Send to Google Sheet
            fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify(formData) }).catch(e=>{});

            setTimeout(() => {
                document.getElementById('reg-view').style.display = 'none';
                document.getElementById('game-section').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                initScratchCard(1);
            }, 1000);
        });

        // --- SCRATCH ENGINE ---
        function initScratchCard(stage) {
            const canvas = document.getElementById('cv' + stage);
            const ctx = canvas.getContext('2d');
            const w = 230, h = 230; // Matches CSS width/height
            canvas.width = w; canvas.height = h;

            // Gradient Overlay
            const grd = ctx.createLinearGradient(0, 0, w, h);
            grd.addColorStop(0, "#FF9933");
            grd.addColorStop(0.5, "#FFFFFF");
            grd.addColorStop(1, "#138808");
            ctx.fillStyle = grd; ctx.fillRect(0, 0, w, h);

            // Text
            ctx.fillStyle = "#000080";
            ctx.font = "bold 16px Poppins"; ctx.textAlign = "center";
            ctx.fillText("SCRATCH ME", w/2, h/2);
            ctx.font = "30px Arial"; ctx.fillText("üáÆüá≥", w/2, h/2 - 30);

            let isDrawing = false;
            let completed = false;

            const scratch = (x, y) => {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI * 2); ctx.fill();
            };
            
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const t = e.touches ? e.touches[0] : e;
                return { x: t.clientX - rect.left, y: t.clientY - rect.top };
            };

            const check = () => {
                if (completed) return;
                const pixels = ctx.getImageData(0, 0, w, h).data;
                let clear = 0;
                for (let i = 3; i < pixels.length; i += 16) if (pixels[i] === 0) clear++;
                
                if (clear / (pixels.length / 16) > 0.35) {
                    completed = true;
                    revealCard(stage);
                }
            };

            const start = () => isDrawing = true;
            const move = (e) => { if(isDrawing) { e.preventDefault(); const p = getPos(e); scratch(p.x, p.y); } };
            const end = () => { if(isDrawing) { isDrawing = false; check(); } };

            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('mousemove', move); canvas.addEventListener('touchmove', move, {passive:false});
            window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
        }

        // --- GAME LOGIC ---
        function revealCard(stage) {
            const canvas = document.getElementById('cv' + stage);
            const box = document.getElementById('box-' + stage);
            const btn = document.getElementById('btn-' + stage);

            canvas.style.opacity = '0'; 
            canvas.style.pointerEvents = 'none';

            box.classList.add('card-zoomed');
            btn.style.display = 'inline-block';
            burstConfetti(30);
        }

        function nextCard(currentStage) {
            document.getElementById('stage-' + currentStage).style.display = 'none';

            if(currentStage < 3) {
                const next = currentStage + 1;
                const nextStageEl = document.getElementById('stage-' + next);
                nextStageEl.classList.add('active');
                initScratchCard(next);
            } else {
                document.getElementById('game-section').style.display = 'none';
                document.getElementById('final-summary').style.display = 'block';
                burstConfetti(100);
            }
        }

        // --- UTILS ---
        function burstConfetti(amount) {
            const colors = ['#FF9933', '#138808', '#FFFFFF', '#000080'];
            for(let i=0; i<amount; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + '%';
                c.style.backgroundColor = colors[Math.floor(Math.random()*4)];
                c.style.animationDuration = (Math.random()*2 + 2) + 's';
                document.body.appendChild(c);
            }
        }

        function saveScreenshot() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Processing...";
            
            html2canvas(document.getElementById("captureArea"), {
                scale: 2, useCORS: true, backgroundColor: "#ffffff"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Anadi_Godham_Rewards.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerHTML = "‚úÖ Saved!";
                setTimeout(() => btn.innerHTML = originalText, 2000);
            });
        }
    </script>
</body>
</html>
