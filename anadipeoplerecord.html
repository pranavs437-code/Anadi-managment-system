<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anadi Seva Prakalp - Admin System</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #ff7b00;
            --primary-dark: #e66e00;
            --secondary: #1e293b;
            --bg-body: #f8fafc;
            --white: #ffffff;
            --gray-light: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--secondary);
            margin: 0; padding: 0; padding-bottom: 80px;
        }

        /* --- LAYOUT --- */
        .app-container { display: flex; min-height: 100vh; }
        
        .sidebar {
            display: none; width: var(--sidebar-width); background: var(--white);
            height: 100vh; position: fixed; left: 0; top: 0;
            border-right: 1px solid var(--gray-light); padding: 20px; z-index: 1000;
            flex-direction: column;
        }

        .main-content { flex: 1; width: 100%; padding: 20px; }

        @media (min-width: 992px) {
            body { padding-bottom: 0; }
            .sidebar { display: flex; }
            .bottom-nav { display: none !important; }
            .main-content { margin-left: var(--sidebar-width); padding: 40px; }
            .form-grid-layout { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .form-grid-full { grid-column: span 2; }
            .stats-grid { grid-template-columns: repeat(4, 1fr) !important; }
            .stat-card.full-width { grid-column: span 1 !important; }
            #recordsList, #homeRecordsList { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        }

        /* --- COMPONENTS --- */
        .logo-area { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
        .logo-area img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary); }
        .app-title h1 { margin: 0; font-size: 18px; color: var(--primary); }
        .app-title p { margin: 0; font-size: 12px; color: #64748b; }

        .mobile-header {
            background: var(--white); padding: 15px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        @media (min-width: 992px) { .mobile-header { display: none; } }

        /* Nav */
        .nav-btn {
            display: flex; align-items: center; gap: 15px; width: 100%; padding: 15px; margin-bottom: 10px;
            border: none; background: transparent; border-radius: 12px; color: #64748b; font-size: 16px; cursor: pointer; transition: 0.3s;
        }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .back-btn { margin-top: auto; background: #fff1f2; color: #be123c; font-weight: 600; }
        .back-btn:hover { background: #ffe4e6; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--white);
            display: flex; justify-content: space-around; padding: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .b-nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 11px; color: #94a3b8; }
        .b-nav-item.active { color: var(--primary); }
        .b-nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-card { 
            background: var(--white); padding: 20px; border-radius: 16px; box-shadow: var(--shadow); 
            position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s, border 0.2s; border: 2px solid transparent;
        }
        .stat-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .stat-card:active { transform: scale(0.98); }
        .stat-card.orange { background: linear-gradient(135deg, #ff9933 0%, #ff7b00 100%); color: white; }
        .stat-val { font-size: 28px; font-weight: 700; }
        .stat-label { font-size: 13px; color: #64748b; margin-top: 5px; }
        .stat-card.orange .stat-label { color: rgba(255,255,255,0.9); }

        /* Forms */
        .card-box { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: var(--shadow); max-width: 900px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #64748b; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid var(--gray-light); border-radius: 10px; font-size: 15px; }
        
        .photo-wrapper { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .photo-circle {
            width: 120px; height: 120px; border-radius: 50%; background: #f8fafc; border: 2px dashed #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative;
        }
        .photo-circle img { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* Camera */
        .camera-area { display: none; text-align: center; margin-bottom: 15px; }
        #videoFeed { width: 100%; max-width: 300px; border-radius: 10px; transform: scaleX(-1); border: 2px solid var(--primary); }
        .cam-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .btn-sm { padding: 8px 15px; font-size: 14px; width: auto; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }

        /* Records List */
        .search-container { position: sticky; top: 0; z-index: 50; background: var(--bg-body); padding: 15px 0; }
        .search-input { width: 100%; padding: 15px 45px; border-radius: 30px; border: none; background: var(--white); box-shadow: var(--shadow); }
        
        .record-card { background: var(--white); border-radius: 16px; padding: 15px; display: flex; gap: 15px; align-items: center; box-shadow: var(--shadow); margin-bottom: 15px; position: relative; transition: 0.2s; }
        .record-card:hover { transform: translateY(-2px); }
        @media (min-width: 992px) { .record-card { flex-direction: column; text-align: center; padding: 25px; margin-bottom: 0; } }
        
        .record-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #f1f5f9; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; margin-top: 5px; }
        .bg-police { background: #e0f2fe; color: #0284c7; }
        .bg-self { background: #dcfce7; color: #16a34a; }
        .date-badge { position: absolute; top: 10px; right: 10px; font-size: 10px; color: #94a3b8; background: #f1f5f9; padding: 3px 8px; border-radius: 5px; }

        /* Action Buttons */
        .action-btn-group { display: flex; gap: 8px; margin-top: 10px; justify-content: flex-end; }
        @media (min-width: 992px) { .action-btn-group { justify-content: center; width: 100%; margin-top: 15px; } }
        .btn-icon { width: 35px; height: 35px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-edit { background: #e0f2fe; color: #0284c7; }
        .btn-pdf { background: #dcfce7; color: #16a34a; }
        .btn-del { background: #fee2e2; color: #ef4444; }

        /* Modals */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .custom-modal.show { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 20px; padding: 25px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #94a3b8; }
        
        /* --- PROFESSIONAL PDF STYLING (UPDATED) --- */
        /* --- PROFESSIONAL PDF STYLING (UPDATED) --- */
#pdfTemplate {
    display: none; /* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ */
    width: 210mm; /* A4 Width */
    min-height: 297mm; /* A4 Height */
    background: #fff;
    font-family: 'Times New Roman', serif; /* Official Font */
    color: #000;
    position: relative;
}

.pdf-container {
    padding: 40px;
    position: relative;
    z-index: 2;
}

/* Watermark Background */
.pdf-watermark {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    opacity: 0.08; /* Very Light */
    z-index: 1;
    pointer-events: none;
}

/* Header Section */
.pdf-header {
    border-bottom: 3px double #d35400; /* Double Line Orange */
    padding-bottom: 15px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.pdf-org-details h1 {
    font-size: 28px;
    font-weight: 800;
    color: #d35400;
    text-transform: uppercase;
    margin: 0;
    letter-spacing: 1px;
}

.pdf-org-details p {
    margin: 5px 0 0;
    font-size: 14px;
    color: #444;
}

.pdf-logo-sm {
    width: 80px;
    height: 80px;
    object-fit: contain;
}

/* Title Badge */
.doc-title {
    text-align: center;
    margin-bottom: 30px;
}
.doc-title span {
    background: #000;
    color: #fff;
    padding: 8px 25px;
    font-size: 16px;
    font-weight: bold;
    text-transform: uppercase;
    border-radius: 50px;
    letter-spacing: 2px;
}

/* Content Layout */
.pdf-content-grid {
    display: flex;
    gap: 30px;
    align-items: flex-start;
}

.pdf-details-col {
    flex: 1;
}

.pdf-photo-col {
    width: 160px;
    text-align: center;
}

.photo-box-frame {
    width: 150px;
    height: 180px;
    border: 1px solid #000;
    padding: 5px;
    background: #fff;
}
.photo-box-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Data Tables */
.info-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.info-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #ddd;
    font-size: 15px;
    vertical-align: top;
}

.label-cell {
    font-weight: bold;
    width: 35%;
    color: #333;
    background: #fdfdfd;
}

.value-cell {
    font-weight: 600;
    color: #000;
}

/* Footer & Signatures */
.pdf-footer {
    margin-top: 60px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.sign-box {
    text-align: center;
    width: 200px;
}

.sign-line {
    border-top: 1px dashed #000;
    margin-bottom: 5px;
    height: 1px;
}

.disclaimer {
    margin-top: 40px;
    font-size: 11px;
    color: #666;
    text-align: justify;
    line-height: 1.4;
    border-top: 1px solid #eee;
    padding-top: 10px;
}

        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo-area">
            <img src="https://anadisevaprakalp.org/wp-content/uploads/2021/07/WhatsApp-Image-2020-11-13-at-6.47.42-PM-1-100x100.png" alt="Logo">
            <div class="app-title">
                <h1>Anadi Seva</h1>
                <p>Admin Dashboard</p>
            </div>
        </div>
        <ul style="list-style: none; padding: 0;">
            <li><button class="nav-btn active" onclick="switchTab('home')"><i class="fa-solid fa-chart-pie"></i> Dashboard</button></li>
            <li><button class="nav-btn" onclick="switchTab('add')"><i class="fa-solid fa-user-plus"></i> New Admission</button></li>
            <li><button class="nav-btn" onclick="switchTab('list')"><i class="fa-solid fa-users"></i> Records</button></li>
        </ul>
        <button class="nav-btn back-btn" onclick="window.location.href='index.html'">
            <i class="fa-solid fa-globe"></i> Back to Website
        </button>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <div class="mobile-header">
            <div class="logo-area" style="margin-bottom:0;">
                <img src="https://anadisevaprakalp.org/wp-content/uploads/2021/07/WhatsApp-Image-2020-11-13-at-6.47.42-PM-1-100x100.png" alt="Logo">
                <div class="app-title">
                    <h1>Anadi Seva</h1>
                    <p>Record Keeper</p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <section id="view-home" class="view-section active">
            <h2 style="margin-bottom: 20px;">Dashboard Overview</h2>
            <p style="font-size: 13px; color: #64748b; margin-top:-15px; margin-bottom: 20px;">Tap on a card to view specific records below.</p>
            
            <div class="stats-grid">
                <div class="stat-card orange full-width" onclick="filterHome('total')">
                    <i class="fa-solid fa-users" style="position: absolute; right: 15px; bottom: 15px; font-size: 40px; opacity: 0.2;"></i>
                    <div class="stat-val" id="totalCount">0</div>
                    <div class="stat-label">Total Inmates</div>
                </div>
                <div class="stat-card" onclick="filterHome('Male')">
                    <div class="stat-val" id="maleCount">0</div>
                    <div class="stat-label">Male</div>
                </div>
                <div class="stat-card" onclick="filterHome('Female')">
                    <div class="stat-val" id="femaleCount">0</div>
                    <div class="stat-label">Female</div>
                </div>
                <div class="stat-card" onclick="filterHome('police')">
                    <div class="stat-val" id="policeCount">0</div>
                    <div class="stat-label">Police Cases</div>
                </div>
            </div>

            <div id="homeResultsArea" style="display:none; animation: fadeIn 0.5s ease;">
                <h3 id="homeFilterTitle" style="color:var(--secondary); border-bottom: 2px solid var(--primary); display:inline-block; padding-bottom:5px; margin-bottom:20px;"></h3>
                <div id="homeRecordsList"></div>
            </div>
        </section>

        <!-- ADD FORM -->
        <section id="view-add" class="view-section">
            <h2 style="margin-bottom: 20px;">New Admission</h2>
            <div class="card-box">
                <form id="addForm">
                    <div class="form-group"><label class="form-label" style="color: var(--primary);">üìÖ Admission Date</label><input type="date" class="form-control" id="admissionDate"></div>
                    
                    <div class="photo-wrapper">
                        <div class="camera-area" id="cameraArea">
                            <video id="videoFeed" autoplay playsinline></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                            <div class="cam-btn-group"><button type="button" class="btn-primary btn-sm" onclick="capturePhoto()">üì∏ Click</button><button type="button" class="btn-primary btn-sm btn-outline" onclick="stopCamera()">Cancel</button></div>
                        </div>
                        <div class="photo-circle" id="photoBox" onclick="showPhotoOptions()"><i class="fa-solid fa-camera fa-2x" style="color:#94a3b8"></i><img id="photoPreview" src=""></div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;"><button type="button" class="btn-primary btn-sm btn-outline" onclick="startCamera()">Camera</button><button type="button" class="btn-primary btn-sm btn-outline" onclick="document.getElementById('photoInput').click()">Gallery</button></div>
                        <input type="file" id="photoInput" accept="image/*" hidden>
                    </div>

                    <div class="form-grid-layout">
                        <div class="form-group form-grid-full"><label class="form-label">Full Name</label><input type="text" class="form-control" id="name" required></div>
                        <div class="form-group"><label class="form-label">Gender</label><select class="form-control" id="gender"><option value="Male">Male</option><option value="Female">Female</option></select></div>
                        <div class="form-group"><div style="display: flex; gap: 10px;"><div style="flex: 1;"><label class="form-label">DOB</label><input type="date" class="form-control" id="dob"></div><div style="flex: 1;"><label class="form-label">Age</label><input type="number" class="form-control" id="age"></div></div></div>
                        <div class="form-group form-grid-full"><label class="form-label">Aadhar No</label><input type="number" class="form-control" id="aadhar"></div>
                        <div class="form-group form-grid-full" style="background: #f8fafc; padding: 15px; border-radius: 10px;"><label class="form-label">Source</label><select class="form-control mb-2" id="source"><option value="Police">Police</option><option value="Children">Children</option><option value="Self">Self</option><option value="Other">Other</option></select><div id="sourceDetails" style="display:none; margin-top: 10px;"><div class="row" style="display: flex; gap: 10px;"><input type="text" class="form-control" id="sourceName" placeholder="Bringer Name" style="flex:1;"><input type="tel" class="form-control" id="sourcePhone" placeholder="Bringer Phone" style="flex:1;"></div></div></div>
                        <div class="form-group"><label class="form-label">Guardian Name</label><input type="text" class="form-control" id="guardianName"></div>
                        <div class="form-group"><label class="form-label">Guardian Phone</label><input type="tel" class="form-control" id="guardianPhone"></div>
                        <div class="form-group form-grid-full"><label class="form-label">Permanent Address</label><textarea class="form-control" id="address" rows="2"></textarea></div>
                        <div class="form-group form-grid-full"><label class="form-label">Temporary Address</label><textarea class="form-control" id="tempAddress" rows="2"></textarea></div>
                    </div>
                    <button type="button" id="saveBtn" class="btn-primary" style="margin-top: 20px;">Save Record</button>
                </form>
            </div>
        </section>

        <!-- RECORDS LIST -->
        <section id="view-list" class="view-section">
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 18px; top: 30px; color: #94a3b8;"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search by Name, Aadhar...">
            </div>
            <div id="recordsList"><p style="text-align:center; color:#94a3b8; margin-top:50px;">Loading...</p></div>
        </section>

    </main>

    <!-- MOBILE NAV -->
    <nav class="bottom-nav">
        <button class="b-nav-item active" onclick="switchTab('home')"><i class="fa-solid fa-house"></i> Home</button>
        <button class="b-nav-item" onclick="switchTab('add')"><i class="fa-solid fa-circle-plus" style="font-size:24px; color:var(--primary)"></i> Add</button>
        <button class="b-nav-item" onclick="switchTab('list')"><i class="fa-solid fa-list"></i> Records</button>
    </nav>
</div>

<!-- FULL EDIT MODAL -->
<div class="custom-modal" id="editModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h3 style="margin-top:0; color:var(--primary);">Edit Full Record</h3>
        <input type="hidden" id="editId">
        <div class="photo-wrapper" style="margin-bottom: 15px;">
            <div class="photo-circle" style="width: 100px; height: 100px;" onclick="document.getElementById('editPhotoInput').click()"><img id="editPhotoPreview" src="" style="display:block;"></div>
            <small style="color:var(--primary); cursor:pointer;" onclick="document.getElementById('editPhotoInput').click()">Tap to Change Photo</small><input type="file" id="editPhotoInput" accept="image/*" hidden>
        </div>
        <div class="form-group"><label class="form-label">Admission Date</label><input type="date" class="form-control" id="editAdmissionDate"></div>
        <div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-control" id="editName"></div>
        <div style="display:flex; gap:10px; margin-bottom:15px;"><div style="flex:1;"><label class="form-label">Age</label><input type="number" class="form-control" id="editAge"></div><div style="flex:1;"><label class="form-label">Gender</label><select class="form-control" id="editGender"><option value="Male">Male</option><option value="Female">Female</option></select></div></div>
        <div class="form-group"><label class="form-label">DOB</label><input type="date" class="form-control" id="editDob"></div>
        <div class="form-group"><label class="form-label">Aadhar No</label><input type="number" class="form-control" id="editAadhar"></div>
        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:10px;"><label class="form-label">Source Type</label><select class="form-control" id="editSource"><option value="Police">Police</option><option value="Children">Children</option><option value="Self">Self</option><option value="Other">Other</option></select><div id="editSourceDetails" style="margin-top:10px;"><input type="text" class="form-control mb-2" id="editSourceName" placeholder="Bringer Name"><input type="text" class="form-control" id="editSourcePhone" placeholder="Bringer Phone"></div></div>
        <div class="form-group"><label class="form-label">Guardian Name</label><input type="text" class="form-control" id="editGName"></div>
        <div class="form-group"><label class="form-label">Guardian Phone</label><input type="text" class="form-control" id="editGPhone"></div>
        <div class="form-group"><label class="form-label">Perm. Address</label><textarea class="form-control" id="editAddr" rows="2"></textarea></div>
        <div class="form-group"><label class="form-label">Temp. Address</label><textarea class="form-control" id="editTempAddr" rows="2"></textarea></div>
        <button class="btn-primary" onclick="saveEdit()">Update Full Record</button>
    </div>
</div>

<!-- PROFESSIONAL PDF TEMPLATE -->
<!-- PROFESSIONAL PDF TEMPLATE (Hidden) -->
<div id="pdfTemplate">
    <!-- Watermark Logo -->
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTpSUECPfnUCAQ0A5l2QBVlZNzlAImCOHl0SA&s" class="pdf-watermark">

    <div class="pdf-container">
        <!-- Header -->
        <header class="pdf-header">
            <div class="pdf-org-details">
                <h1>Anadi Seva Prakalp</h1>
                <p>Old Age Home & Care Center</p>
                <p style="font-size:12px;"> Contact: +91 9810017422, 8052008008</p>
                <p style="font-size:12px;">Address: Anadi Godham Village Pali Faridabad, Haryana </p>
            </div>
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTpSUECPfnUCAQ0A5l2QBVlZNzlAImCOHl0SA&s" class="pdf-logo-sm">
        </header>

        <!-- Document Title -->
        <div class="doc-title">
            <span>Inmate Admission Record</span>
        </div>

        <!-- Main Body -->
        <div class="pdf-content-grid">
            
            <!-- Left: Details -->
            <div class="pdf-details-col">
                <table class="info-table">
                    <tr>
                        <td class="label-cell">Registration ID</td>
                        <td class="value-cell" id="pdfRefId">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Full Name</td>
                        <td class="value-cell" id="pdfName" style="text-transform:uppercase; font-size:16px;">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Admission Date</td>
                        <td class="value-cell" id="pdfDate">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Gender / Age</td>
                        <td class="value-cell" id="pdfAgeGender">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Date of Birth</td>
                        <td class="value-cell" id="pdfDob">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Aadhar Number</td>
                        <td class="value-cell" id="pdfAadhar">--</td>
                    </tr>
                </table>

                <h4 style="margin: 15px 0 10px 0; border-bottom:1px solid #d35400; color:#d35400; display:inline-block;">Guardian / Source Details</h4>
                <table class="info-table">
                    <tr>
                        <td class="label-cell">Admission Source</td>
                        <td class="value-cell" id="pdfSource">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Guardian Name</td>
                        <td class="value-cell" id="pdfGName">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Contact Phone</td>
                        <td class="value-cell" id="pdfGPhone">--</td>
                    </tr>
                    <tr>
                        <td class="label-cell">Permanent Address</td>
                        <td class="value-cell" id="pdfAddr" style="font-size:13px;">--</td>
                    </tr>
                </table>
            </div>

            <!-- Right: Photo -->
            <div class="pdf-photo-col">
                <div class="photo-box-frame">
                    <img id="pdfPhoto" src="" alt="Inmate Photo">
                </div>
                <p style="font-size:11px; margin-top:5px; font-weight:bold;">OFFICIAL PHOTO</p>
                <div style="border:1px solid #ccc; height:60px; margin-top:15px; display:flex; align-items:center; justify-content:center;">
                    <span style="font-size:10px; color:#ccc;">Thumb / Sign</span>
                </div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <strong>Declaration:</strong> This record confirms the admission of the individual named above into Anadi Seva Prakalp. All information provided has been verified to the best of our ability. This document is for official organizational use only.
        </div>

        <!-- Footer Signatures -->
        <div class="pdf-footer">
            <div class="sign-box">
                <div class="sign-line"></div>
                <span>Guardian / Bringer Sign</span>
            </div>
            <div class="sign-box">
                <img src="" style="height:40px; display:none;" id="authSignImg"> <!-- Optional for digital sign -->
                <div class="sign-line"></div>
                <span style="font-weight:bold; color:#d35400;">Authorized Signatory</span><br>
                <span style="font-size:12px;">(Anadi Seva Prakalp)</span>
            </div>
        </div>
    </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8zdM9Mx5qMRk71C57oCagKfSHFZZXx58",
    authDomain: "anadipeoplerecord.firebaseapp.com",
    databaseURL: "https://anadipeoplerecord-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "anadipeoplerecord",
    storageBucket: "anadipeoplerecord.firebasestorage.app",
    messagingSenderId: "739962751112",
    appId: "1:739962751112:web:c5f37aa6b2ee286d6f773d",
    measurementId: "G-VDWCB4D20F"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --- GLOBALS ---
  document.getElementById('admissionDate').valueAsDate = new Date();
  let imgBase64 = "", editImgBase64 = "", allRecords = [];
  const DEFAULT_PHOTO = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";

  // --- 1. IMAGE COMPRESSION LOGIC (Quality & Size Reducer) ---
  // ‡§Ø‡§π ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã ‡§õ‡•ã‡§ü‡§æ (KB ‡§Æ‡•á‡§Ç) ‡§¨‡§®‡§æ ‡§¶‡•á‡§ó‡§æ ‡§ö‡§æ‡§π‡•á ‡§Ø‡•Ç‡§ú‡§∞ 10MB ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§® ‡§°‡§æ‡§≤‡•á
  function compressImage(sourceUrl, quality, maxWidth, outputId) {
      const img = new Image();
      img.src = sourceUrl;
      img.crossOrigin = "Anonymous"; // PDF CORS Issue Fix

      img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Resize Logic (Ratio maintain ‡§ï‡§∞‡§§‡•á ‡§π‡•Å‡§è ‡§õ‡•ã‡§ü‡§æ ‡§ï‡§∞‡§®‡§æ)
          if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // Result: Data URL with low quality (0.6 = 60%)
          const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
          
          if(outputId === 'add') {
              imgBase64 = compressedDataUrl;
              document.getElementById('photoPreview').src = compressedDataUrl;
              document.getElementById('photoPreview').style.display = 'block';
              document.querySelector('.photo-circle i').style.display = 'none';
          } else if (outputId === 'edit') {
              editImgBase64 = compressedDataUrl;
              document.getElementById('editPhotoPreview').src = compressedDataUrl;
          }
      };
  }

  // --- 2. CAMERA FIX (Memory Leak Solved) ---
  let stream = null; 
  const video = document.getElementById('videoFeed');
  
  window.startCamera = async function() { 
      document.getElementById('cameraArea').style.display = 'block'; 
      try { 
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); 
          video.srcObject = stream; 
      } catch (err) { alert("Camera access denied or error."); } 
  };

  window.capturePhoto = function() { 
      if (!stream) return;
      const c = document.getElementById('canvas'); 
      c.width = video.videoWidth; 
      c.height = video.videoHeight; 
      c.getContext('2d').drawImage(video, 0, 0); 
      
      const rawData = c.toDataURL('image/jpeg'); 
      // Capture ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§¨‡§æ‡§¶ Compress ‡§ï‡§∞‡•á‡§Ç (Max width 800px, Quality 0.6)
      compressImage(rawData, 0.6, 800, 'add');
      
      stopCamera(); 
  };

  // Memory Leak Fix: Tracks ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π stop ‡§ï‡§∞‡§®‡§æ
  window.stopCamera = function() { 
      if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
          video.srcObject = null;
      }
      document.getElementById('cameraArea').style.display = 'none'; 
  };

  // File Upload Handling with Compression
  document.getElementById('photoInput').addEventListener('change', (e) => handleFileSelect(e, 'add'));
  document.getElementById('editPhotoInput').addEventListener('change', (e) => handleFileSelect(e, 'edit'));

  function handleFileSelect(e, type) {
      const f = e.target.files[0]; 
      if (f) { 
          const r = new FileReader(); 
          r.onload = (evt) => { 
              // ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§ï‡§Æ‡•ç‡§™‡•ç‡§∞‡•á‡§∏ ‡§ï‡§∞‡•á‡§Ç
              compressImage(evt.target.result, 0.6, 800, type);
          }; 
          r.readAsDataURL(f); 
      }
  }

  // --- FORM LOGIC ---
  document.getElementById('source').addEventListener('change', function() { document.getElementById('sourceDetails').style.display = this.value ? 'block' : 'none'; });
  document.getElementById('dob').addEventListener('change', function() { calculateAge(this.value, 'age'); });
  document.getElementById('editDob').addEventListener('change', function() { calculateAge(this.value, 'editAge'); });

  function calculateAge(dobVal, fieldId) {
      if(!dobVal) return;
      const d = new Date(dobVal), t = new Date(); 
      let a = t.getFullYear() - d.getFullYear(); 
      if(t.getMonth() < d.getMonth() || (t.getMonth()===d.getMonth() && t.getDate() < d.getDate())) a--; 
      document.getElementById(fieldId).value = a;
  }
  
  // --- SAVE ---
  document.getElementById('saveBtn').addEventListener('click', () => {
      const name = document.getElementById('name').value; if (!name) { alert("Enter Name"); return; }
      const btn = document.getElementById('saveBtn'); btn.innerHTML = 'Saving...'; btn.disabled = true;
      
      const data = {
          admissionDate: document.getElementById('admissionDate').value, name: name, gender: document.getElementById('gender').value,
          dob: document.getElementById('dob').value, age: document.getElementById('age').value, aadhar: document.getElementById('aadhar').value,
          sourceType: document.getElementById('source').value, sourceName: document.getElementById('sourceName').value, sourcePhone: document.getElementById('sourcePhone').value,
          guardianName: document.getElementById('guardianName').value, guardianPhone: document.getElementById('guardianPhone').value,
          address: document.getElementById('address').value, tempAddress: document.getElementById('tempAddress').value,
          photo: imgBase64 || DEFAULT_PHOTO, timestamp: new Date().toISOString()
      };
      
      push(ref(db, 'inmates_records'), data).then(() => { 
          alert("‚úÖ Saved!"); 
          document.getElementById('addForm').reset(); 
          document.getElementById('admissionDate').valueAsDate = new Date(); 
          imgBase64 = ""; 
          document.getElementById('photoPreview').style.display = 'none'; 
          document.querySelector('.photo-circle i').style.display = 'block'; 
          btn.innerHTML = 'Save Record'; btn.disabled = false; 
          switchTab('list'); 
      }).catch(e => { alert("Error: " + e.message); btn.disabled = false; btn.innerHTML = 'Save Record'; });
  });

  // --- READ RECORDS ---
  onValue(ref(db, 'inmates_records'), (snapshot) => {
      const data = snapshot.val(); allRecords = []; let m=0, f=0, p=0, t=0;
      if(data) {
          Object.keys(data).forEach(key => { const r = data[key]; r.id = key; allRecords.push(r); t++; if(r.gender==='Male')m++; else f++; if(r.sourceType==='Police')p++; });
          allRecords.sort((a,b) => new Date(b.admissionDate) - new Date(a.admissionDate));
          renderCard(null, document.getElementById('recordsList'), true);
      } else { document.getElementById('recordsList').innerHTML = '<p style="text-align:center; color:#999;">No records found.</p>'; }
      document.getElementById('totalCount').innerText = t; document.getElementById('maleCount').innerText = m; document.getElementById('femaleCount').innerText = f; document.getElementById('policeCount').innerText = p;
  });

  // --- FILTER ---
  window.filterHome = function(type) {
      const container = document.getElementById('homeRecordsList'); const title = document.getElementById('homeFilterTitle'); const area = document.getElementById('homeResultsArea');
      container.innerHTML = ""; let filtered = [];
      if (type === 'total') filtered = allRecords; else if (type === 'police') filtered = allRecords.filter(r => r.sourceType === 'Police'); else filtered = allRecords.filter(r => r.gender === type);
      area.style.display = 'block'; title.innerText = `Showing: ${type.toUpperCase()} (${filtered.length})`;
      if(filtered.length === 0) container.innerHTML = '<p style="color:#999;">No records.</p>'; else filtered.forEach(r => renderCard(r, container));
      area.scrollIntoView({behavior: 'smooth'});
  }

  function renderCard(rec, container, renderAll = false) {
      if(renderAll) { container.innerHTML = ""; allRecords.forEach(r => renderCard(r, container)); return; }
      const div = document.createElement('div'); div.className = 'record-card';
      div.innerHTML = `
          <div class="date-badge">üìÖ ${rec.admissionDate || '-'}</div><img src="${rec.photo}" class="record-img">
          <div style="flex:1; text-align:left;"><h4 style="margin:0 0 5px 0;">${rec.name}</h4><small style="color:#64748b;">${rec.gender}, ${rec.age}y</small><br><span class="badge ${rec.sourceType==='Police'?'bg-police':'bg-self'}">${rec.sourceType||'Unknown'}</span><div style="font-size:12px; margin-top:5px; color:#666;">GDN: ${rec.guardianName||'-'}<br>Phone: ${rec.guardianPhone||'-'}</div></div>
          <div class="action-btn-group"><button class="btn-icon btn-pdf" onclick="window.downloadPDF('${rec.id}')"><i class="fa-solid fa-file-pdf"></i></button><button class="btn-icon btn-edit" onclick="window.editRec('${rec.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-icon btn-del" onclick="window.deleteRec('${rec.id}')"><i class="fa-solid fa-trash"></i></button></div>`;
      container.appendChild(div);
  }

  // --- 4. LOGIC BUG FIXED (Edit Initialization) ---
  window.editRec = function(id) { 
      const r = allRecords.find(x => x.id === id); if(!r) return; 
      
      // Reset logic to prevent data bleeding
      document.getElementById('editId').value = id; 
      
      document.getElementById('editAdmissionDate').value = r.admissionDate||''; 
      document.getElementById('editName').value = r.name; 
      document.getElementById('editAge').value = r.age; 
      document.getElementById('editGender').value = r.gender; 
      document.getElementById('editDob').value = r.dob||''; 
      document.getElementById('editAadhar').value = r.aadhar||''; 
      
      document.getElementById('editSource').value = r.sourceType||'Other'; 
      document.getElementById('editSourceName').value = r.sourceName||''; 
      document.getElementById('editSourcePhone').value = r.sourcePhone||''; 
      
      document.getElementById('editGName').value = r.guardianName; 
      document.getElementById('editGPhone').value = r.guardianPhone; 
      document.getElementById('editAddr').value = r.address; 
      document.getElementById('editTempAddr').value = r.tempAddress||''; 
      
      // Fix: Ensure editImgBase64 is set to current photo initially
      document.getElementById('editPhotoPreview').src = r.photo; 
      editImgBase64 = r.photo; 
      
      document.getElementById('editModal').classList.add('show'); 
  };

  window.saveEdit = function() {
      const id = document.getElementById('editId').value;
      const up = { 
          admissionDate: document.getElementById('editAdmissionDate').value, 
          name: document.getElementById('editName').value, 
          age: document.getElementById('editAge').value, 
          gender: document.getElementById('editGender').value, 
          dob: document.getElementById('editDob').value, 
          aadhar: document.getElementById('editAadhar').value, 
          sourceType: document.getElementById('editSource').value, 
          sourceName: document.getElementById('editSourceName').value, 
          sourcePhone: document.getElementById('editSourcePhone').value, 
          guardianName: document.getElementById('editGName').value, 
          guardianPhone: document.getElementById('editGPhone').value, 
          address: document.getElementById('editAddr').value, 
          tempAddress: document.getElementById('editTempAddr').value, 
          photo: editImgBase64 // Uses updated compressed photo or old one
      };
      update(ref(db, 'inmates_records/'+id), up).then(() => { alert("‚úÖ Updated!"); window.closeEditModal(); });
  };
  
  window.closeEditModal = function() { document.getElementById('editModal').classList.remove('show'); };

  // --- PDF GENERATOR (CORS Fix Implemented in compressImage + Here) ---
  // --- PROFESSIONAL PDF GENERATOR ---
window.downloadPDF = function(id) {
    const rec = allRecords.find(r => r.id === id); if(!rec) return;

    // Data Fill
    document.getElementById('pdfRefId').innerText = "#" + id.substring(1, 8).toUpperCase();
    document.getElementById('pdfDate').innerText = rec.admissionDate || '-';
    document.getElementById('pdfName').innerText = rec.name || '-';
    document.getElementById('pdfAgeGender').innerText = `${rec.gender || '-'}  |  ${rec.age || '-'} Years`;
    document.getElementById('pdfDob').innerText = rec.dob || 'Not Available';
    document.getElementById('pdfAadhar').innerText = rec.aadhar || 'Not Available';
    
    // Source Logic
    let sourceText = rec.sourceType || 'Other';
    if(rec.sourceName) sourceText += ` (By: ${rec.sourceName})`;
    document.getElementById('pdfSource').innerText = sourceText;

    document.getElementById('pdfGName').innerText = rec.guardianName || 'N/A';
    document.getElementById('pdfGPhone').innerText = rec.guardianPhone || rec.sourcePhone || 'N/A';
    document.getElementById('pdfAddr').innerText = rec.address || 'Address not provided';
    
    // Photo
    document.getElementById('pdfPhoto').src = rec.photo;

    const element = document.getElementById('pdfTemplate');
    element.style.display = 'block';

    // Settings for Best Quality
    const opt = {
        margin: 0, // No margin, we handle it in CSS
        filename: `ASP_Record_${rec.name.replace(/\s+/g, '_')}_${rec.admissionDate}.pdf`,
        image: { type: 'jpeg', quality: 1 }, // Max quality
        html2canvas: { scale: 2, useCORS: true, logging: false }, // Scale 2 for Retina clarity
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // Show loading state (optional)
    const btn = event.currentTarget;
    const oldHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

    html2pdf().set(opt).from(element).save().then(() => {
        element.style.display = 'none';
        btn.innerHTML = oldHtml;
    });
};

  // --- 3. SEARCH DEBOUNCING (Performance Fix) ---
  let debounceTimer;
  document.getElementById('searchInput').addEventListener('input', (e) => {
      const val = e.target.value.toLowerCase();
      const container = document.getElementById('recordsList');
      
      container.innerHTML = '<p style="text-align:center;color:#999">Searching...</p>';
      
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
          container.innerHTML = "";
          const filtered = allRecords.filter(r => 
              (r.name && r.name.toLowerCase().includes(val)) || 
              (r.aadhar && r.aadhar.includes(val))
          );
          
          if(filtered.length === 0) container.innerHTML = '<p style="text-align:center; color:#999;">No match found.</p>';
          else filtered.forEach(r => renderCard(r, container));
      }, 400); // 400ms delay - ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡•á ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§æ‡§∞ ‡§ï‡§∞‡•á‡§ó‡§æ
  });

  // --- UTILS ---
  window.deleteRec = function(id) { if(confirm("Are you sure you want to delete this record permanently?")) remove(ref(db, 'inmates_records/'+id)); };
  window.switchTab = function(t) { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active')); document.getElementById('view-'+t).classList.add('active'); const idx = t==='home'?0:t==='add'?1:2; document.querySelectorAll('.b-nav-item').forEach(e => e.classList.remove('active')); document.querySelectorAll('.b-nav-item')[idx].classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active')); document.querySelectorAll('.nav-btn')[idx].classList.add('active'); };

</script>

</body>
</html>
